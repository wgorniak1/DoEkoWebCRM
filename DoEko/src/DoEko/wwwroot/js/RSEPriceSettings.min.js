"use strict";function onResetModalCancel(){var i=$("#ResetModal"),r=i.data("section"),t,n;i.data("section","");r==="tax"?(t=$("#TaxTable").DataTable(),n=$("div#TaxTable_processing"),n.hide()):(t=$("#NetTable").DataTable(),n=$("div#NetTable_processing"),n.hide());t.buttons().enable()}function onResetModalSubmit(){var i=$("#ResetModal"),f=i.data("section"),t,n,r,u;if(i.data("section",""),i.modal("hide"),f==="tax")t=$("#TaxTable"),n=t.DataTable(),r="/api/v1/RSERules/Tax?projectId="+t.data("projectid");else if(f==="net")t=$("#NetTable"),n=t.DataTable(),r="/api/v1/RSERules/Price?projectId="+t.data("projectid");else{WgTools.alert("Coś poszło nie tak. Proszę skontaktować się z administratorem strony.",!1,"E");return}u=$.ajax({url:r,type:"DELETE",data:{},contentType:"application/json"});u.done(function(){n.buttons().enable();n.buttons(["btnDivide:name",["btnJoin:name"]]).disable();n.ajax.reload();n.rows().cells().invalidate().render();WgTools.alert("Pomyślnie przywrócono wartości początkowe.",!0,"S");var t=$("#searchRSEType").val(""),i=$("#searchLocalization").val(""),r=$("#searchBuilding").val("");n.column(0).search("").draw();n.column(1).search("").draw();n.column(2).search("").draw()});u.fail(function(){WgTools.alert("Coś poszło nie tak. Proszę skontaktować się z administratorem strony.",!1,"E")})}function onTableDataChanged(n){var r=n.data.dt,u=$(this).attr("name"),t=$(this).val(),f=r.row($(this).parents("tr")),i=f.data();switch(u){case"usableAreaMin":i.usableAreaMin=parseFloat(t);break;case"usableAreaMax":i.usableAreaMax=t==="99999.99"?Number.MAX_VALUE:parseFloat(t);break;case"vat":i.vat=parseInt(t);break;case"unit":i.unit=parseInt(t);r.rows(function(n,t){return t.surveyType===i.surveyType&&t.rseType===i.rseType?!0:!1}).every(function(){this.data().unit=parseInt(t);this.invalidate()}).draw();break;case"numberMin":i.numberMin=parseFloat(t);break;case"numberMax":i.numberMax=t==="99999.99"?Number.MAX_VALUE:parseFloat(t);break;case"netPrice":i.netPrice=parseFloat(t);break;case"multiply":i.multiply=t==="on"?!0:!1}r.buttons("btnSave:name").length===0&&r.button().add(r.buttons().length,{name:"btnSave",text:'<span class="text-primary glyphicon glyphicon glyphicon-save"><\/span> Zapisz',titleAttr:"Zapamiętaj wprowadzone zmiany",className:"btn",action:function(n,t){var h=!1,i,e,r,u,o,s,f;if(t.buttons().disable(),i=t.rows().data().toArray(),r=$(t.table().node()).data("projectid"),i[0].projectId=="1"){for(u=0;u<i.length;u++)i[u].ProjectId=r;h=!0;e="POST"}else e="PUT";t.table().node().id=="TaxTable"?(o="/api/v1/RSERules/Tax",s={ProjectId:r,TaxRules:i}):(o="/api/v1/RSERules/Price",s={ProjectId:r,PriceRules:i});f=$.ajax({url:o,type:e,data:JSON.stringify(s),dataType:"json",contentType:"application/json"});f.always(function(){t.buttons().enable();t.buttons(["btnDivide:name","btnJoin:name"]).disable()});f.done(function(){t.ajax.reload();t.rows().cells().invalidate().render();WgTools.alert("Pomyślnie zapisano ustawienia.",!0,"S");t.button("btnSave:name").remove()});f.fail(function(n){var u,f,r,e,o,s;if(h)for(u=0;u<i.length;u++)i[u].ProjectId="1";switch(n.status){case 400:f=n.responseJSON;r=[];r.push("Błąd walidacji danych:");for(e in f)f[e].forEach(function(n){$.inArray(n,r)===-1&&r.push(n)}),o=parseInt(e.match(/\d+/)),o!==NaN&&(s=$(t.row(o).node()),s.addClass("wg-bg-danger"));WgTools.alert(r,!1,"E");break;case 401:WgTools.alert("Brak połączenia z serwerem. Proszę odświeżyć stronę",!1,"E");break;default:WgTools.alert("Coś poszło nie tak. Proszę skontaktować się z administratorem strony.",!1,"E")}})}})}function onTableDataMaxChanged(n){var t=n.data.dt,i=t.row($(this).parents("tr"))}function InitializeTaxTab(n){var i="/api/v1/RSERules/Tax?projectId="+n+"&getDefaults=True",t=$("#TaxTable").DataTable({ajax:{url:i,dataSrc:""},columnDefs:[{className:"text-right",targets:[3,4,5]}],columns:[{data:null,name:"primaryKey",title:"Klucz",type:"string",visible:!1,orderable:!0,render:function(n){return n.surveyType.toString()+n.rseType.toString()+n.installationLocalization.toString()+n.buildingPurpose.toString()+(n.usableAreaMin*100).toString()}},{data:null,name:"rseType",title:"Typ OZE",type:"html",orderable:!1,render:function(n,t){switch(t){default:return WgEnums.rse.getText(n.surveyType,n.rseType)}}},{data:"installationLocalization",name:"installationLocalization",title:"Lokalizacja",orderable:!1,render:function(n,t){switch(t){default:return WgEnums.localization.getText(n)}}},{data:"buildingPurpose",name:"buildingPurpose",title:"Przezn. Budynku",orderable:!1,render:function(n,t){switch(t){default:return WgEnums.building.Text(n)}}},{data:"usableAreaMin",name:"usableAreaMin",title:"Powierzchnia Od",type:"html-num",orderable:!1,render:function(n,t){switch(t){case"display":var i='<input type="number" name="usableAreaMin" class="form-control input-sm wg-data wg-data-min" value="'+n+'" step="0.1" min="0.0" max="99999.9">';return WgTaxTableEdit===!0?i:n;default:return n}}},{data:"usableAreaMax",name:"usableAreaMax",title:"Powierzchnia Do",type:"html-num",orderable:!1,render:function(n,t,i){var r,u,f,e,o;switch(t){case"display":return n===Number.MAX_VALUE?(r="99999.99",u="99999.99",f="99999.99",e=!1):(r=n,u=(i.usableAreaMin+1).toString(),f="99999.99",e=!0),o='<input type="number" class="form-control input-sm wg-data wg-data-max" name="usableAreaMax" value = "'+r+'" step = "0.1" min = "'+u+'" max = "'+f+'" '+(e===!1?"disabled> ":"> "),WgTaxTableEdit===!0?o:r;default:return n===Number.MAX_VALUE?"99999.99":n}}},{data:"vat",name:"vat",title:"VAT",type:"html-num-fmt",orderable:!1,render:function(n,t){switch(t){default:return $("<select>",{name:"vat","class":"form-control input-sm wg-data wg-data-tax",disabled:!WgTaxTableEdit}).addOptions([{value:"0",text:"0 %"},{value:"5",text:"5 %"},{value:"8",text:"8 %"},{value:"23",text:"23 %"}],n).prop("outerHTML")}}}],stateSave:!1,paging:!1,language:WgLanguage,ordering:!0,order:[["0","asc"]],processing:!0,serverSide:!1,dom:"<'row wg-dt-padding'<'col-sm-12'B>><'row'<'col-sm-12'tr>><'row wg-dt-padding'<'col-sm-12'i>>",buttons:[{text:'<span class="text-primary glyphicon glyphicon glyphicon-retweet"><\/span> Resetuj',titleAttr:"Przywróć ustawienia domyślne",className:"btn",name:"btnReset",action:function(n,t){t.table().buttons().disable();$("div#TaxTable_processing").show();var i=$("#ResetModal");i.data("section","tax");i.modal("show")}},{text:'<span class="text-primary glyphicon glyphicon-refresh"><\/span> Odśwież',titleAttr:"Odśwież zawartość z bazy danych",className:"btn",name:"btnRefresh",action:function(n,t){t.ajax.reload();t.rows().cells().invalidate().render();t.button("btnSave:name").remove()}},{extend:"selectedSingle",text:'<span class="text-primary glyphicon glyphicon glyphicon-resize-full"><\/span> Podziel',titleAttr:"Podziel przedział powierzchni",className:"btn",name:"btnDivide",action:function(n,i){var f=i.row({selected:!0,page:"current"}),r,u,o,e;f!==undefined&&(r=f.data(),u=r.usableAreaMax===Number.MAX_VALUE?"99999.99":r.usableAreaMax,u=u-(u-r.usableAreaMin)/2,o=t.row.add({project:null,projectId:r.projectId,surveyType:r.surveyType,rseType:r.rseType,installationLocalization:r.installationLocalization,buildingPurpose:r.buildingPurpose,usableAreaMin:u,usableAreaMax:r.usableAreaMax,vat:r.vat}).invalidate().draw().node(),r.usableAreaMax=u,e=f.invalidate().draw().node(),$("input.wg-data",e).trigger("change"))}},{extend:"selectedSingle",text:'<span class="text-primary glyphicon glyphicon glyphicon-resize-full"><\/span> Usuń',titleAttr:"Usuń przedział powierzchni",name:"btnJoin",className:"btn",action:function(n,t){var i=t.row({selected:!0,page:"current"}),r;i!==undefined&&(r=i.data(),$("input.wg-data",i.node()).trigger("change"),i.remove().draw())}}],select:"single",responsive:!0,fixedHeader:{headerOffset:$("#NavBarMain").outerHeight()},drawCallback:function(){$("#TaxTable thead tr th").each(function(){});var n=this.api(),t=n.rows().indexes();$("#TaxTable tbody tr").each(function(){var r=n.row($(this)),i=t.indexOf(r.index()),u=n.rows(i-1).data(),f=n.rows(i+1).data()})}});$("#TaxTable").on("change","input.wg-data, select.wg-data",{dt:$("#TaxTable").dataTable().api()},onTableDataChanged);$("#TaxTable thead tr th").each(function(n){var r=$(this).text()+": ",i,u,f;switch(n){case 0:i=new mySelect(WgEnums.rse.asKeyValueArray(!1),!0,-1,r,"searchRSEType");$(this).html(i.domNode);break;case 1:i=new mySelect(WgEnums.localization.asKeyValueArray(!1),!0,-1,r,"searchLocalization");$(this).html(i.domNode);break;case 2:i=new mySelect(WgEnums.building.asKeyValueArray(!1),!0,-1,r,"searchBuilding");$(this).html(i.domNode);break;default:u=document.createElement("div");u.className="form-group form-inline";f=document.createElement("p");f.appendChild(document.createTextNode(r));f.className="form-control-static";u.appendChild(f);$(this).html(u)}$("select",this).on("change",function(){t.column(n+1).search()!==this.value&&t.column(n+1).search(this.value).draw()})});$("#TaxTable").on("change","input.wg-data-max",{dt:$("#TaxTable").dataTable().api()},onTableDataMaxChanged);$("body").on("click","button.resetmodal-btn-cancel",onResetModalCancel);$("body").on("click","button.resetmodal-btn-submit",onResetModalSubmit)}function InitializeNetTab(n){var i="/api/v1/RSERules/Price?projectId="+n+"&getDefaults=True",t=$("#NetTable").DataTable({ajax:{url:i,dataSrc:""},columns:[{data:null,name:"primaryKey",title:"Klucz",type:"string",visible:!1,orderable:!0,render:function(n){var t=(n.numberMin*100).toFixed(0),i=("000000000"+t).substr(-10);return n.surveyType.toString()+n.rseType.toString()+n.unit.toString()+i}},{data:null,name:"rseType",title:"Typ OZE",type:"html",orderable:!1,render:function(n,t){switch(t){case"display":return'<div class="form-group form-inline"><p class="form-control-static">'+WgEnums.rse.getText(n.surveyType,n.rseType)+"<\/p><\/div>";default:return WgEnums.rse.getText(n.surveyType,n.rseType)}}},{data:"unit",name:"unit",title:"Jednostka",type:"html",orderable:!1,render:function(n,t){switch(t){case"display":var i=$("<select />",{name:"unit","class":"form-control input-sm wg-data wg-data-unit",disabled:!WgNetTableEdit}).addOptions([{value:"1",text:"Moc ostateczna"},{value:"2",text:"Liczba zestawów"}],n+"").addClass(WgNetTableEdit===!0?"":"disabled");return i.prop("outerHTML");default:return n}}},{data:"numberMin",name:"numberMin",title:"Od",type:"html-num",orderable:!1,render:function(n,t){switch(t){case"display":var i='<input type="number" name="numberMin" class="form-control input-sm wg-data wg-data-min" value="'+n+'" step="0.1" min="0.0" max="99999.9">';return WgNetTableEdit===!0?i:n;default:return n}}},{data:"numberMax",name:"numberMax",title:"Do",type:"html-num",orderable:!1,render:function(n,t,i){var r=n===Number.MAX_VALUE?"99999.99":n,u,f;switch(t){case"display":return u=i.unit===1?.1:1,f='<input type="number" name="numberMax" class="form-control input-sm wg-data wg-data-max" value="'+r+'" step="'+u+'" min="0.0" max="99999.9">',WgNetTableEdit===!0?f:n;default:return r}}},{data:"netPrice",name:"netPrice",title:"Cena Netto",orderable:!1,type:"html-num",render:function(n,t){switch(t){case"display":var i;return i='<input type="number" name="netPrice" min="0" max="99999" step="1" class="form-control input-sm wg-data wg-data-price" value="'+n+'"/>',WgNetTableEdit===!0?i:n;default:return n}}},{data:"multiply",name:"multiply",title:"cena jednostkowa",orderable:!1,type:"html",render:function(n,t){switch(t){case"display":var i;return i='<input name="multiply"  class="form-control input-sm checkbox wg-data wg-data-multiply"  data-toggle="toggle" data-on="Tak" data-off="Nie" type="checkbox"',i+=n===!0?" checked />":"/>",WgNetTableEdit===!0?i:n;default:return n}}}],stateSave:!1,paging:!1,serverSide:!1,language:WgLanguage,ordering:!0,order:[[0,"asc"]],processing:!0,dom:"<'row wg-dt-padding'<'col-sm-12'B>><'row'<'col-sm-12'tr>><'row wg-dt-padding'<'col-sm-12'i>>",buttons:[{text:'<span class="text-primary glyphicon glyphicon glyphicon-retweet"><\/span> Resetuj',titleAttr:"Przywróć ustawienia domyślne",className:"btn",name:"btnReset",action:function(n,t){t.table().buttons().disable();$("div#NetTable_processing").show();var i=$("#ResetModal");i.data("section","net");i.modal("show")}},{text:'<span class="text-primary glyphicon glyphicon-refresh"><\/span> Odśwież',titleAttr:"Odśwież zawartość z bazy danych",className:"btn",name:"btnRefresh",action:function(n,t){$("div#NetTable_processing").show();t.ajax.reload();t.rows().cells().invalidate().render();t.button("btnSave:name").remove();WgTools.alert("Odświeżanie zakończone",!0,"S")}},{extend:"selectedSingle",text:'<span class="text-primary glyphicon glyphicon glyphicon-resize-full"><\/span> Podziel',titleAttr:"Podziel przedział",className:"btn",name:"btnDivide",action:function(n,i){var f=i.row({selected:!0,page:"current"}),r,u,o,e;f!==undefined&&(r=f.data(),u=r.numberMax===Number.MAX_VALUE?"99999.99":r.numberMax,u=u-(u-r.numberMin)/2,o=t.row.add({project:null,projectId:r.projectId,surveyType:r.surveyType,rseType:r.rseType,unit:r.unit,numberMin:u,numberMax:r.numberMax,netPrice:r.netPrice,multiply:r.multiply}).invalidate().draw().node(),r.numberMax=u,e=f.invalidate().draw().node(),$("input.wg-data",e).trigger("change"))}},{extend:"selectedSingle",text:'<span class="text-primary glyphicon glyphicon glyphicon-resize-full"><\/span> Usuń',titleAttr:"Usuń przedział",name:"btnJoin",className:"btn",action:function(n,t){var i=t.row({selected:!0,page:"current"}),r;i!==undefined&&(r=i.data(),$("input.wg-data",i.node()).trigger("change"),i.remove().draw())}},],select:"single",responsive:!0,fixedHeader:{headerOffset:$("#NavBarMain").outerHeight()},drawCallback:function(){var n=this.api(),t,i;$("#NetTable thead tr th").each(function(){});t=n.rows().indexes();$("#NetTable tbody tr").each(function(){var r=n.row($(this)),i=t.indexOf(r.index()),u=n.rows(i-1).data(),f=n.rows(i+1).data()});i=$("#NetTable tbody");$('input[data-toggle="toggle"]',i).bootstrapToggle()}});$("#NetTable").on("change","input.wg-data, select.wg-data",{dt:$("#NetTable").dataTable().api()},onTableDataChanged);$("#NetTable thead tr th").each(function(n){var u=$(this).text()+": ",f,i,r;switch(n){case 0:f=new mySelect(WgEnums.rse.asKeyValueArray(!1),!0,-1,u,"searchRSETypeNet");$(this).html(f.domNode);break;default:i=document.createElement("div");i.className="form-group form-inline";r=document.createElement("p");r.appendChild(document.createTextNode(u));r.className="form-control-static";i.appendChild(r);$(this).html(i)}$("select",this).on("change",function(){t.column(n+1).search()!==this.value&&t.column(n+1).search(this.value).draw()})});$("#NetTable tbody").on("change",".wg-data-unit",t,function(){});class r{constructor(n){this.value=parseFloat(n.val());this.max=parseFloat(n.attr("max"));this.min=parseFloat(n.attr("min"))}isValid(){return this.value<=this.max&&this.value>=this.min?!0:!1}get value(){return this.value>=this.max?this.max:this.value<=this.min?this.min:this.value}}$("#NetTable tbody").on("change",".number-max",t,function(n){var i=$(this),r=parseFloat(i.val()),f={min:parseFloat(i.attr("min")),max:parseFloat(i.attr("max"))},e,t,u;(r<f.min?i.val(f.min):r>f.max&&i.val(f.max),e=n.data.row($(this).parent()),t=e.data(),t.numberMax!==r)&&(u=n.data.row(function(n,i){return i.surveyType===t.surveyType&&i.rseType===t.rseType&&i.numberMax>t.numberMax?!0:!1}),t.numberMax=r,u.length>0&&(u.data().numberMin=r,u.invalidate(),u.draw(!1)),n.stopPropagation())});$("#NetTable tbody").on("click","input, select",t,function(n){n.stopPropagation()})}(function(n){n.fn.addOptions=function(n,t){return!n||Object.values(n[0]).length<2?this:this.filter("select").each(function(){var i=this;n.forEach(function(n){var r=document.createElement("option");r.setAttribute("value",n.value);n.value===t.toString()&&r.setAttribute("selected","");r.appendChild(document.createTextNode(n.text));i.appendChild(r)})})}})(jQuery);class mySelect{constructor(n=[{value:"",text:""}],t=true,i=-1,r="",u=""){var e=document.createElement("select"),s=document.createElement("div"),f,h=0,c=n.length,o;for(s.className="form-group form-inline",e.setAttribute("id",u),e.className="form-control input-sm",t===!0&&(f=document.createElement("option"),f.setAttribute("value",""),f.appendChild(document.createTextNode("")),e.appendChild(f));h<c;h+=1)f=document.createElement("option"),f.setAttribute("value",n[h].value),f.appendChild(document.createTextNode(n[h].text)),e.appendChild(f);r.length>0?(o=document.createElement("label"),o.setAttribute("for",u),o.appendChild(document.createTextNode(r)),o.appendChild(e),s.appendChild(o)):s.appendChild(e);this.domNode=s}}class WgRSEEnum{constructor(){this.surveyType=["CO","CWU","EE"];this.rseType=[["","Pompa Ciepła Grunt.","Kocioł na Pellet","Pompa Ciepła Powietrzna"],["","","","Solary","Pompa Ciepła"],["","","","","","Panele Fotowolt."]]}getText(n,t,i){return t===undefined?this.surveyType[n]:i?this.rseType[n][t]:this.rseType[n][t]+" ("+this.surveyType[n]+")"}getId(n,t){for(var u,r=-1,f=-1,i=0;i<this.surveyType.length;i++)this.surveyType[i]===n&&(r=i);if(t===undefined)return r;if(r>=0)for(u=0;u<this.rseType[r].length;u++)this.surveyType[r][i]===n&&(f=i);return f}asKeyValueArray(n=false){for(var i,r=[],t=0;t<this.surveyType.length;t++)i=this.surveyType[t],this.rseType[t].forEach(function(u,f){u.length>0&&r.push(n===!0?{value:t.toString().concat(f.toString()),text:u+" ("+i+")"}:{value:u+" ("+i+")",text:u+" ("+i+")"})});return r}}class WgLocEnum{constructor(){this._array=["Dach","Grunt","Elewacja"]}getText(n){return this._array[n]}getValue(n){for(var t=0;t<this._array.length;t++)if(this._array[t]===n)return t}asKeyValueArray(n=false){var t=[];return this._array.forEach(function(i,r){i.length>0&&t.push(n===!0?{value:r.toString(),text:i}:{value:i,text:i})}),t}}class WgBdgEnum{constructor(){this._array=["Gospodarczy","Mieszkalny"]}Text(n){return this._array[n]}Value(n){for(var t=0;t<this._array.length;t++)if(this._array[t]===n)return t}asKeyValueArray(n=false){var t=[];return this._array.forEach(function(i,r){i.length>0&&t.push(n===!0?{value:r.toString(),text:i}:{value:i,text:i})}),t}}var WgEnums={rse:new WgRSEEnum,localization:new WgLocEnum,building:new WgBdgEnum},WgTaxTableEdit=!0,WgNetTableEdit=!0;$(document).ready(function(){var n=$("#TaxTable").data("projectid");InitializeTaxTab(n);InitializeNetTab(n);$("#TabsContainer ul li a").click(function(){var n=$(this).attr("href"),t=$("table",$(n)).attr("id"),i=$("#"+t).dataTable().api();new $.fn.dataTable.FixedHeader(i,{headerOffset:$("#NavBarMain").outerHeight()})})});